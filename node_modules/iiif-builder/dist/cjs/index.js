"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var y=require("@iiif/vault/actions"),X=require("@iiif/vault");const Y={id:"https://iiif-parser/annotation-page",type:"AnnotationPage",behavior:[],motivation:null,label:null,thumbnail:[],summary:null,requiredStatement:null,metadata:[],rights:null,provider:[],items:[],seeAlso:[],homepage:[],logo:[],rendering:[],service:[]},Z={id:"https://iiif-parser/empty-canvas",type:"Canvas",label:null,behavior:[],motivation:null,thumbnail:[],posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:[],rights:null,navDate:null,provider:[],items:[],annotations:[],seeAlso:[],homepage:[],logo:[],partOf:[],rendering:[],service:[],duration:0,height:0,width:0},I={id:"https://iiif-parser/empty-collection",type:"Collection",label:null,viewingDirection:"left-to-right",behavior:[],motivation:null,thumbnail:[],posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:[],rights:null,navDate:null,provider:[],items:[],annotations:[],seeAlso:[],homepage:[],logo:[],partOf:[],rendering:[],service:[],services:[]},w={id:"https://iiif-parser/empty-manifest",type:"Manifest",annotations:[],behavior:[],homepage:[],items:[],label:null,logo:[],metadata:[],motivation:null,navDate:null,provider:[],partOf:[],posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,rendering:[],requiredStatement:null,rights:null,seeAlso:[],service:[],services:[],start:null,structures:[],summary:null,thumbnail:[],viewingDirection:"left-to-right"},S=["sc:Collection","sc:Manifest","sc:Canvas","oa:AnnotationList","oa:Annotation","sc:Range","sc:Layer","sc:Sequence","oa:Choice","Service","ContentResource"];function G(t){if(typeof t>"u"||t===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(t))throw new Error("Array is not a valid entity");if(typeof t!="object")throw new Error(`${typeof t} is not a valid entity`);if(typeof t["@type"]=="string"){const e=S.indexOf(t["@type"]);if(e!==-1)return S[e]}if(t.profile)return"Service";if(t.format||t["@type"])return"ContentResource";throw new Error("Resource type is not known")}class C{traversals;options;constructor(e,i={}){this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...e},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...i}}static all(e){return new C({collection:[e],manifest:[e],canvas:[e],annotationList:[e],sequence:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],layer:[e]})}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(e))),this.traversals.collection)}traverseCollectionItems(e){if(this.options.mergeMemberProperties){const i=[...(e.manifests||[]).map(s=>typeof s=="string"?{"@id":s,"@type":"sc:Manifest"}:s),...(e.collections||[]).map(s=>typeof s=="string"?{"@id":s,"@type":"sc:Collection"}:s),...e.members||[]];delete e.collections,delete e.manifests,e.members=i}return e.manifests&&(e.manifests=e.manifests.map(i=>this.traverseManifest(typeof i=="string"?{"@id":i,"@type":"sc:Manifest"}:i))),e.collections&&(e.collections=e.collections.map(i=>this.traverseCollection(typeof i=="string"?{"@id":i,"@type":"sc:Collection"}:i))),e.members&&(e.members=e.members.map(i=>typeof i=="string"?i:this.traverseUnknown(i))),e}traverseManifest(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))),this.traversals.manifest)}traverseManifestItems(e){return e.sequences&&(e.sequences=e.sequences.map(i=>this.traverseSequence(i))),e.structures&&(e.structures=e.structures.map(i=>this.traverseRange(i))),e}traverseSequence(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(e))),this.traversals.sequence)}traverseSequenceItems(e){return e.canvases&&(e.canvases=e.canvases.map(i=>this.traverseCanvas(i))),e}traverseCanvas(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))),this.traversals.canvas)}traverseCanvasItems(e){return e.images&&(e.images=e.images.map(i=>this.traverseAnnotation(i))),e.otherContent&&(e.otherContent=e.otherContent.map(i=>this.traverseAnnotationList(i))),e}traverseRange(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(e))),this.traversals.range)}traverseRangeItems(e){if(this.options.mergeMemberProperties){const i=[...(e.ranges||[]).map(s=>typeof s=="string"?{"@id":s,"@type":"sc:Range"}:s),...(e.canvases||[]).map(s=>typeof s=="string"?{"@id":s,"@type":"sc:Canvas"}:s),...e.members||[]];delete e.ranges,delete e.canvases,e.members=i.length?i.map(s=>this.traverseUnknown(s)):void 0}return e}traverseAnnotationList(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationListItems(e))),this.traversals.annotationList)}traverseAnnotationListItems(e){return e.resources&&(e.resources=e.resources.map(i=>this.traverseAnnotation(i))),e}traverseAnnotation(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(e))),this.traversals.annotation)}traverseAnnotationItems(e){return e.resource&&(e.resource=this.traverseContentResource(e.resource)),e.on,e}traverseLayer(e){return this.traverseType(this.traverseLinking(this.traverseLayerItems(e)),this.traversals.layer)}traverseLayerItems(e){return e.otherContent&&(e.otherContent=e.otherContent.map(i=>this.traverseAnnotationList(i))),e}traverseChoice(e){return this.traverseType(this.traverseChoiceItems(e),this.traversals.choice)}traverseChoiceItems(e){return e.default&&e.default!=="rdf:nil"&&(e.default=this.traverseContentResource(e.default)),e.item&&e.item!=="rdf:nil"&&(e.item=e.item.map(i=>this.traverseContentResource(i))),e}traverseService(e){return this.traverseType(this.traverseLinking(e),this.traversals.service)}traverseContentResource(e){return e["@type"]==="oa:Choice"?this.traverseChoice(e):this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.contentResource)}traverseUnknown(e){if(!e["@type"]||typeof e=="string")return e;switch(G(e)){case"sc:Collection":return this.traverseCollection(e);case"sc:Manifest":return this.traverseManifest(e);case"sc:Canvas":return this.traverseCanvas(e);case"sc:Sequence":return this.traverseSequence(e);case"sc:Range":return this.traverseRange(e);case"oa:Annotation":return this.traverseAnnotation(e);case"oa:AnnotationList":return this.traverseAnnotationList(e);case"sc:Layer":return this.traverseLayer(e);case"Service":return this.traverseService(e);case"oa:Choice":return this.traverseChoice(e);case"ContentResource":return this.traverseContentResource(e)}return e.profile?this.traverseService(e):e}traverseImageResource(e){const i=Array.isArray(e),s=Array.isArray(e)?e:[e],n=[];for(const r of s)typeof r=="string"?n.push(this.traverseContentResource({"@id":r,"@type":"dctypes:Image"})):n.push(this.traverseContentResource(r));return!i&&!this.options.convertPropsToArray?n[0]:n}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=this.traverseImageResource(e.thumbnail)),e.logo&&(e.logo=this.traverseImageResource(e.logo)),e}traverseOneOrMoreServices(e){const i=Array.isArray(e),s=Array.isArray(e)?e:[e],n=[];for(const r of s)n.push(this.traverseService(r));return!i&&!this.options.convertPropsToArray?n[0]:n}traverseLinking(e){return e.related&&(e.related=this.traverseOneOrManyType(e.related,this.traversals.contentResource)),e.rendering&&(e.rendering=this.traverseOneOrManyType(e.rendering,this.traversals.contentResource)),e.service&&(e.service=this.traverseOneOrMoreServices(e.service)),e.seeAlso&&(e.seeAlso=this.traverseOneOrManyType(e.seeAlso,this.traversals.contentResource)),e.within&&(typeof e.within=="string"||(e.within=this.traverseOneOrManyType(e.within,this.traversals.contentResource))),e.startCanvas&&(typeof e.startCanvas=="string"?e.startCanvas=this.traverseType({"@id":e.startCanvas,"@type":"sc:Canvas"},this.traversals.canvas):e.startCanvas&&this.traverseType(e.startCanvas,this.traversals.canvas)),e.contentLayer&&(typeof e.contentLayer=="string"?e.contentLayer=this.traverseLayer({"@id":e.contentLayer,"@type":"sc:Layer"}):e.contentLayer=this.traverseLayer(e.contentLayer)),e}traverseOneOrManyType(e,i){if(!Array.isArray(e))if(this.options.convertPropsToArray)e=[e];else return this.traverseType(e,i);return e.map(s=>this.traverseType(s,i))}traverseType(e,i){return i.reduce((s,n)=>{const r=n(s);return typeof r>"u"&&!this.options.allowUndefinedReturn?s:r},e)}}const _="http://library.stanford.edu/iiif/image-api/compliance.html#level0",R="http://library.stanford.edu/iiif/image-api/compliance.html#level1",L="http://library.stanford.edu/iiif/image-api/compliance.html#level2",ee="http://library.stanford.edu/iiif/image-api/conformance.html#level0",M="http://library.stanford.edu/iiif/image-api/conformance.html#level1",x="http://library.stanford.edu/iiif/image-api/conformance.html#level2",te="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",T="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",O="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",ie="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",P="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",k="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",se="http://iiif.io/api/image/1/level0.json",ne="http://iiif.io/api/image/1/profiles/level0.json",E="http://iiif.io/api/image/1/level1.json",j="http://iiif.io/api/image/1/profiles/level1.json",B="http://iiif.io/api/image/1/level2.json",q="http://iiif.io/api/image/1/profiles/level2.json",re="http://iiif.io/api/image/2/level0.json",ae="http://iiif.io/api/image/2/profiles/level0.json",D="http://iiif.io/api/image/2/level1.json",$="http://iiif.io/api/image/2/profiles/level1.json",W="http://iiif.io/api/image/2/level2.json",H="http://iiif.io/api/image/2/profiles/level2.json",oe="level0",F="level1",N="level2",he="http://iiif.io/api/image/2/level0",U="http://iiif.io/api/image/2/level1",V="http://iiif.io/api/image/2/level2",ce=[U,V,R,L,M,x,T,O,P,k,E,j,B,q,D,$,W,H,F,N],de=[he,U,V,_,R,L,ee,M,x,te,T,O,ie,P,k,se,ne,E,j,B,q,re,ae,D,$,W,H,oe,F,N],g={attributionLabel:"Attribution",lang:"none",providerId:"http://example.org/provider",providerName:"Unknown"};function p(t,e="none"){if(!t)return{};const i=Array.isArray(t)?t:[t],s={};for(const n of i){if(typeof n=="string"){s[e]=s[e]?s[e]:[],s[e].push(n||"");continue}if(!n["@language"]){s[e]=s[e]?s[e]:[],s[e].push(n["@value"]||"");continue}const r=n["@language"];s[r]=s[r]?s[r]:[],s[r].push(n["@value"]||"")}return s}function z(t){if(Array.isArray(t))return z(t.find(e=>typeof e=="string"));if(de.indexOf(t)!==-1)return"level2";if(ce.indexOf(t)!==-1)return"level1";if(typeof t=="string")return t}function le(t){const e=Array.isArray(t)?t:[t];for(const i of e)switch(i){case"http://iiif.io/api/image/2/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":return"ImageService2";case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return"ImageService1";case"http://iiif.io/api/annex/openannotation/context.json":return"ImageApiSelector"}}function ue(t){switch(t){case"http://iiif.io/api/image/2/level0.json":case"http://iiif.io/api/image/2/level1.json":case"http://iiif.io/api/image/2/level2.json":return"ImageService2";case"http://iiif.io/api/auth/1/kiosk":case"http://iiif.io/api/auth/1/login":case"http://iiif.io/api/auth/1/clickthrough":case"http://iiif.io/api/auth/1/external":case"http://iiif.io/api/auth/0/kiosk":case"http://iiif.io/api/auth/0/login":case"http://iiif.io/api/auth/0/clickthrough":case"http://iiif.io/api/auth/0/external":return"AuthCookieService1";case"http://iiif.io/api/auth/1/token":case"http://iiif.io/api/auth/0/token":return"AuthTokenService1";case"http://iiif.io/api/auth/1/logout":case"http://iiif.io/api/auth/0/logout":return"AuthLogoutService1";case"http://iiif.io/api/search/1/search":case"http://iiif.io/api/search/0/search":return"SearchService1";case"http://iiif.io/api/search/1/autocomplete":case"http://iiif.io/api/search/0/autocomplete":return"AutoCompleteService1"}}function pe(t){return Array.isArray(t)?t:[t]}function fe(t){for(const e of["sc","oa","dcterms","dctypes","iiif"])if(t.startsWith(`${e}:`))return t.slice(e.length+1);return t}const ve=["Collection","Manifest","Annotation","AnnotationPage","Range","Service"];function b(t){const e=t["@id"]||t.id;let i=t["@type"]||t.type;const s=t.profile||void 0,n=t["@context"]||void 0;if(s){const r=ue(s);if(r)return r}if(n){const r=le(n);if(r)return r}if(i){if(Array.isArray(i)){if(i.indexOf("oa:CssStylesheet")!==-1)return"CssStylesheet";if(i.indexOf("cnt:ContentAsText")!==-1)return"TextualBody";i=i[0]}for(const r of["sc","oa","dcterms","dctypes","iiif"])if(i.startsWith(`${r}:`)){i=i.slice(r.length+1);break}switch(i){case"Layer":return"AnnotationCollection";case"AnnotationList":return"AnnotationPage";case"cnt:ContentAsText":return"TextualBody"}}if(i&&ve.indexOf(i)!==-1)return i;if(t.format){if(t.format.startsWith("image/"))return"Image";if(t.format.startsWith("text/")||t.format==="application/pdf")return"Text";if(t.format.startsWith("application/"))return"Dataset"}return e&&(e.endsWith(".jpg")||e.endsWith(".png")||e.endsWith(".jpeg"))?"Image":i||"unknown"}const me=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function ye(t){const e=t.match(me);return e?e[0]:t}function ge(t,e="Rights/License",i="none"){let s=null;const n=[],r=Array.isArray(t)?t:[t];for(const a of r){const o=a?ye(a):void 0;if(o&&(o.indexOf("creativecommons.org")!==-1||o.indexOf("rightsstatements.org")!==-1)){o.startsWith("https://")?s=`http://${o.slice(8)}`:s=o;continue}o&&n.push({label:{[i]:[e]},value:{[i]:[o]}})}return[s,n]}const be=["http://iiif.io/api/presentation/2/context.json","http://iiif.io/api/image/2/context.json","http://iiif.io/api/image/1/context.json","http://library.stanford.edu/iiif/image-api/1.1/context.json","http://iiif.io/api/search/1/context.json","http://iiif.io/api/search/0/context.json","http://iiif.io/api/auth/1/context.json","http://iiif.io/api/auth/0/context.json","http://iiif.io/api/annex/openannotation/context.json"];function Ae(t){if(t){const e=Array.isArray(t)?t:[t],i=[];for(const s of e)s==="http://iiif.io/api/presentation/2/context.json"&&i.push("http://iiif.io/api/presentation/3/context.json"),be.indexOf(s)===-1&&i.push(s);if(e.length)return i.length===1?i[0]:i}}function Ce(t){return t?t.map(e=>({label:p(e.label),value:p(e.value)})):[]}function d(t){for(const e in t)(typeof t[e]>"u"||t[e]===null)&&delete t[e];return t}let J=0;function K(t,e){const i=encodeURI(t.id||t["@id"]||"").trim();return i&&e?`${i}/${e}`:i||(J++,`http://example.org/${t["@type"]}${e?`/${e}`:""}/${J}`)}function l(t){const e=[...t.behavior||[]];return t.viewingHint&&e.push(t.viewingHint),{"@context":t["@context"]?Ae(t["@context"]):void 0,id:(t["@id"]||K(t)).trim(),type:b(t),behavior:e.length?e:void 0,height:t.height?t.height:void 0,width:t.width?t.width:void 0,motivation:t.motivation?fe(t.motivation):void 0,viewingDirection:t.viewingDirection,profile:t.profile,format:t.format?t.format:void 0,duration:void 0,timeMode:void 0}}function c(t){const[e,i]=ge(t.license),s=[...t.metadata?Ce(t.metadata):[],...i];return{rights:e,metadata:s.length?s:void 0,label:t.label?p(t.label):void 0,requiredStatement:t.attribution?{label:p(g.attributionLabel),value:p(t.attribution)}:void 0,navDate:t.navDate,summary:t.description?p(t.description):void 0,thumbnail:t.thumbnail}}function Ie(t){if(!t.within)return;const e=Array.isArray(t.within)?t.within:[t.within],i=[];for(const s of e)if(typeof s=="string"){if(s)switch(t["@type"]){case"sc:Manifest":i.push({id:s,type:"Collection"});break}}else s["@id"]&&i.push({id:s["@id"],type:b(s)});return i.length?i:void 0}function u(t){const e=t.related?Array.isArray(t.related)?t.related:[t.related]:[],i=t.contentLayer;return{provider:t.logo||e.length?[{id:g.providerId,type:"Agent",homepage:e.length?[e[0]]:void 0,logo:t.logo?Array.isArray(t.logo)?t.logo:[t.logo]:void 0,label:p(g.providerName)}]:void 0,partOf:Ie(t),rendering:t.rendering,seeAlso:t.seeAlso,start:t.startCanvas,service:t.service?pe(t.service):void 0,supplementary:i?[i]:void 0}}function we(t){return d({...l(t),...c(t),...u(t),items:t.members})}function Se(t){const e=[],i=[];for(const n of t.sequences||[])n.canvases.length&&e.push(...n.canvases),n.behavior&&i.push(...n.behavior);const s=l(t);return i.length&&(s.behavior?s.behavior.push(...i):s.behavior=i),d({...s,...c(t),...u(t),items:e,structures:t.structures})}function Re(t){return d({...l(t),...c(t),...u(t),items:t.images&&t.images.length?[{id:K(t,"annotation-page"),type:"AnnotationPage",items:t.images}]:void 0})}function Le(t){return d({...l(t),...c(t),...u(t),items:t.resources})}function Me(t){return!t.canvases||t.canvases.length===0?{canvases:[],behavior:[]}:{canvases:t.canvases,behavior:t.viewingHint?[t.viewingHint]:[]}}function xe(t){return d({...l(t),...c(t),...u(t),target:typeof t.on=="string"?encodeURI(t.on).trim():t.on,body:t.resource})}function Te(t){const e=t;return d({...l(e),...c(e),...u(e)})}function Oe(t){const e=[];return t.default&&t.default!=="rdf:nil"&&e.push(t.default),t.item&&t.item!=="rdf:nil"&&e.push(...t.item),{...l(t),...c(t),items:e}}function Pe(t){return d({...l(t),...c(t),...u(t),items:t.members})}function ke(t){const{"@id":e,"@type":i,"@context":s,profile:n,...r}=t;return e&&(r.id=e),r.type=b(t),r.type==="unknown"&&(r.type="Service"),n&&(r.profile=z(n)),d({...r,...c(r)})}function Ee(t){return d({...l(t),...c(t),...u(t)})}new C({collection:[we],manifest:[Se],canvas:[Re],annotationList:[Le],sequence:[Me],annotation:[xe],contentResource:[Te],choice:[Oe],range:[Pe],service:[ke],layer:[Ee]});class f{builder;entity;modified=new Set;newInstances=[];editedInstances=[];embeddedInstances=[];get id(){return this.entity.id}reset(e){this.entity=e,this.modified=new Set,this.embeddedInstances=[],this.editedInstances=[],this.newInstances=[]}dispose(){for(const e of this.newInstances)e.dispose();for(const e of this.editedInstances)e.dispose();this.builder=null,this.entity=null,this.modified=null,this.newInstances=null,this.editedInstances=null}constructor(e,i){this.builder=e,this.entity={...i}}getEmbeddedInstances(){const e=[];for(const i of this.editedInstances)e.push(...i.getEmbeddedInstances());return e.push(...this.embeddedInstances),e}getModifiedFields(){const e=[];for(const i of this.editedInstances)e.push(...i.getModifiedFields());for(const i of this.modified.values()){const s=this.entity[i];e.push({id:this.entity.id,type:this.entity.type,value:s,key:i})}return e}getModifiedEntities(){const e=[];for(const i of this.editedInstances)e.push(...i.getNestedEntities()),e.push(i.entity);return e}getNestedEntities(){const e=[];for(const i of this.newInstances)e.push(...i.getNestedEntities()),e.push(i.entity);for(const i of this.editedInstances)e.push(...i.getEmbeddedInstances());return e.push(...this.embeddedInstances),e}set label(e){this.setLabel(e)}setLabel(e){this.modified.add("label"),this.entity.label=e}addLabel(e,i){this.addLanguageProperty("label",e,i)}set metadata(e){this.setMetadata(e)}setMetadata(e){this.modified.add("metadata"),this.entity.metadata=e}addMetadata(e,i){this.modified.add("metadata"),this.entity.metadata=[...this.entity.metadata,{label:e,value:i}]}set summary(e){this.setLabel(e)}setSummary(e){this.modified.add("summary"),this.entity.summary=e}addSummary(e,i){this.addLanguageProperty("summary",e,i)}set requiredStatement(e){this.setRequiredStatement(e)}setRequiredStatement(e){this.modified.add("requiredStatement"),this.entity.requiredStatement=e}set rights(e){this.setRights(e)}setRights(e){this.modified.add("rights"),this.entity.rights=e}addThumbnail(e){this.modified.add("thumbnail"),this.entity.thumbnail=[...this.entity.thumbnail,this.addEmbeddedInstance(e,"ContentResource")]}set height(e){this.setHeight(e)}setHeight(e){this.isCanvas(this.entity)&&(this.modified.add("height"),this.entity.height=e)}set width(e){this.setWidth(e)}setWidth(e){this.isCanvas(this.entity)&&(this.modified.add("width"),this.entity.width=e)}set duration(e){this.setDuration(e)}setDuration(e){this.isCanvas(this.entity)&&(this.modified.add("duration"),this.entity.duration=e)}set viewingDirection(e){this.setViewingDirection(e)}setViewingDirection(e){if(this.isManifest(this.entity)){let i="left-to-right";switch(e){case"left-to-right":case 0:i="left-to-right";break;case"right-to-left":case 1:i="right-to-left";break;case"top-to-bottom":case 2:i="top-to-bottom";break;case"bottom-to-top":case 3:i="bottom-to-top";break}this.modified.add("viewingDirection"),this.entity.viewingDirection=i}}set behavior(e){this.setBehavior(e)}set behaviour(e){this.setBehavior(e)}setBehavior(e){this.modified.add("behavior"),this.entity.behavior=Array.isArray(e)?e:[e]}setBehaviour(e){this.setBehavior(e)}addBehaviour(e){this.addBehavior(e)}addBehavior(e){this.modified.add("behavior"),this.entity.behavior=[...this.entity.behavior,e]}set seeAlso(e){this.setSeeAlso(e)}setSeeAlso(e){this.modified.add("seeAlso"),this.entity.seeAlso=e.map(i=>this.addEmbeddedInstance(i,"ContentResource"))}addSeeAlso(e){this.modified.add("seeAlso"),this.entity.seeAlso=[...this.entity.seeAlso,this.addEmbeddedInstance(e,"ContentResource")]}set service(e){this.setService(e)}addServiceProperty(e){this.modified.add("service"),this.entity.service=[...this.entity.service,e]}setService(e){this.modified.add("service"),this.entity.service=e}set homepage(e){this.setHomepage(e)}setHomepage(e){this.modified.add("homepage"),this.entity.homepage=[...this.entity.homepage,this.addEmbeddedInstance(e,"ContentResource")]}set rendering(e){this.setRendering(e)}setRendering(e){this.modified.add("rendering"),this.entity.rendering=e.map(i=>this.addEmbeddedInstance(i,"ContentResource"))}addRendering(e){this.modified.add("rendering"),this.entity.rendering=[...this.entity.rendering,this.addEmbeddedInstance(e,"ContentResource")]}set partOf(e){this.setPartOf(e)}setPartOf(e,i=!0){(this.isCollection(this.entity)||this.isManifest(this.entity)||this.isCanvas(this.entity))&&(this.modified.add("partOf"),this.entity.partOf=e)}isPartOf(e){(this.isCollection(this.entity)||this.isManifest(this.entity)||this.isCanvas(this.entity))&&(this.modified.add("partOf"),this.entity.partOf=[...this.entity.partOf,e])}set start(e){this.setStart(e)}setStart(e){this.isManifest(this.entity)&&(this.entity.start=e)}addAnnotations(e){this.isCanvas(this.entity)&&(this.modified.add("annotations"),this.entity.annotations=[...this.entity.annotations,this.addEmbeddedInstance(e,"AnnotationPage")])}set services(e){this.setServices(e)}addServicesProperty(e){this.isManifest(this.entity)&&(this.modified.add("services"),this.entity.services=[...this.entity.services,e])}setServices(e){this.isManifest(this.entity)&&(this.modified.add("services"),this.entity.services=e)}addEmbeddedInstance(e,i){return this.embeddedInstances.push(e),{id:e.id,type:i||e.type}}isAnnotationPage(e){return e.type==="AnnotationPage"}isCanvas(e){return e.type==="Canvas"}isManifest(e){return e.type==="Manifest"}isCollection(e){return e.type==="Collection"}addLanguageProperty(e,i,s="none"){if(typeof this.entity[e]<"u")this.modified.add(e),this.entity[e]=this.entity[e]?this.entity[e]:{},this.entity[e][s]=Array.isArray(i)?i:[i];else throw new Error(`Invalid field "${e}"`)}}class je extends f{defaultAnnotationTarget;constructor(e,i,s){super(e,i);this.defaultAnnotationTarget=s}createAnnotation(e){this.defaultAnnotationTarget&&!e.target&&(e.target=this.defaultAnnotationTarget);const i=Array.isArray(e.body)?e.body:[e.body];e.body=i.map(n=>{if(n&&n.type==="Choice"){const r=n;return r.items=r.items.map(a=>this.addEmbeddedInstance(a,"ContentResource")),this.addEmbeddedInstance(r,"ContentResource")}return this.addEmbeddedInstance(n,"ContentResource")});const s=this.addEmbeddedInstance(e,"Annotation");this.modified.add("items"),this.entity.items=[...this.entity.items,s]}}class Q extends f{firstAnnotationPage;constructor(e,i){super(e,i)}createAnnotationPage(e,i){const s=new je(this.builder,{...Y,id:e},this.entity.id);i(s),this.newInstances.push(s),this.firstAnnotationPage||(this.firstAnnotationPage=s),this.modified.add("items"),this.entity.items=[...this.entity.items,{id:e,type:"AnnotationPage"}]}createAnnotation(e,i){this.firstAnnotationPage?this.firstAnnotationPage.createAnnotation(i):this.createAnnotationPage(`${this.entity.id}/annotation-page`,s=>{s.createAnnotation(i)})}}class A extends f{constructor(e,i){super(e,i)}createCanvas(e,i){const s=new Q(this.builder,{...Z,id:e});i(s),this.newInstances.push(s),this.modified.add("items"),this.entity.items=[...this.entity.items,{id:e,type:"Canvas"}]}editCanvas(e,i){const s=this.builder.vault.get({id:e,type:"Canvas"}),n=new Q(this.builder,{...s});i(n),this.newInstances.push(n)}}class v extends f{constructor(e,i){super(e,i)}createManifest(e,i){const s=new A(this.builder,{...w,id:e});i(s),this.newInstances.push(s),this.modified.add("items"),this.entity.items=[...this.entity.items,s.entity]}createCollection(e,i){const s=new v(this.builder,{...I,id:e});i(s),this.newInstances.push(s),this.modified.add("items"),this.entity.items=[...this.entity.items,s.entity]}}class Be{vault;constructor(e){this.vault=e||new X.Vault}processBuilder(e,i){const s=e.entity,n=e.getModifiedFields(),r=this.vault.getStore(),a={Manifest:{},Annotation:{},AnnotationCollection:{},AnnotationPage:{},Canvas:{},Collection:{},ContentResource:{},Range:{},Selector:{},Service:{}},o={};i&&(o[s.id]=s.type,a[s.type][s.id]=s);const m=e.getNestedEntities();if(m.length)for(const h of m)o[h.id]=a[h.type]?h.type:"ContentResource",(a[h.type]?a[h.type]:a.ContentResource)[h.id]=h;(m.length||i)&&(r.dispatch(y.entityActions.importEntities({entities:a})),r.dispatch(y.mappingActions.addMappings({mapping:o})));for(const h of n)a[h.type][h.id]||r.dispatch(y.entityActions.modifyEntityField(h));e.dispose()}createCollection(e,i){const s=new v(this,{...I,id:e});return i(s),this.processBuilder(s,!0),this.vault.get({id:e,type:"Collection"})}editCollection(e,i){const s=this.vault.get({id:e,type:"Collection"}),n=new v(this,{...s});return i(n),this.processBuilder(n,!1),this.vault.get({id:e,type:"Collection"})}createManifest(e,i){const s=new A(this,{...w,id:e});return i(s),this.processBuilder(s,!0),this.vault.get({id:e,type:"Manifest"})}editManifest(e,i){const s=this.vault.get({id:e,type:"Manifest"}),n=new A(this,{...s});return i(n),this.processBuilder(n,!1),this.vault.get({id:e,type:"Manifest"})}toPresentation3(e){return this.vault.toPresentation3(e)}toPresentation2(e){return this.vault.toPresentation2(e)}}exports.IIIFBuilder=Be;
